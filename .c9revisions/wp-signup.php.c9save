{"ts":1371501428812,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n\n/** Sets up the WordPress Environment. */\nrequire( dirname(__FILE__) . '/wp-load.php' );\n\nadd_action( 'wp_head', 'wp_no_robots' );\n\nrequire( './wp-blog-header.php' );\n\nif ( is_array( get_site_option( 'illegal_names' )) && isset( $_GET[ 'new' ] ) && in_array( $_GET[ 'new' ], get_site_option( 'illegal_names' ) ) == true ) {\n\twp_redirect( network_home_url() );\n\tdie();\n}\n\nfunction do_signup_header() {\n\tdo_action( 'signup_header' );\n}\nadd_action( 'wp_head', 'do_signup_header' );\n\nif ( !is_multisite() ) {\n\twp_redirect( site_url('wp-login.php?action=register') );\n\tdie();\n}\n\nif ( !is_main_site() ) {\n\twp_redirect( network_site_url( 'wp-signup.php' ) );\n\tdie();\n}\n\n// Fix for page title\n$wp_query->is_404 = false;\n\nfunction wpmu_signup_stylesheet() {\n\t?>\n\t<style type=\"text/css\">\n\t\t.mu_register { width: 90%; margin:0 auto; }\n\t\t.mu_register form { margin-top: 2em; }\n\t\t.mu_register .error { font-weight:700; padding:10px; color:#333333; background:#FFEBE8; border:1px solid #CC0000; }\n\t\t.mu_register input[type=\"submit\"],\n\t\t\t.mu_register #blog_title,\n\t\t\t.mu_register #user_email,\n\t\t\t.mu_register #blogname,\n\t\t\t.mu_register #user_name { width:100%; font-size: 24px; margin:5px 0; }\n\t\t.mu_register .prefix_address,\n\t\t\t.mu_register .suffix_address {font-size: 18px;display:inline; }\n\t\t.mu_register label { font-weight:700; font-size:15px; display:block; margin:10px 0; }\n\t\t.mu_register label.checkbox { display:inline; }\n\t\t.mu_register .mu_alert { font-weight:700; padding:10px; color:#333333; background:#ffffe0; border:1px solid #e6db55; }\n\t</style>\n\t<?php\n}\n\nadd_action( 'wp_head', 'wpmu_signup_stylesheet' );\nget_header();\n\ndo_action( 'before_signup_form' );\n?>\n<div id=\"content\" class=\"widecolumn\">\n<div class=\"mu_register\">\n<?php\nfunction show_blog_form($blogname = '', $blog_title = '', $errors = '') {\n\tglobal $current_site;\n\t// Blog name\n\tif ( !is_subdomain_install() )\n\t\techo '<label for=\"blogname\">' . __('Site Name:') . '</label>';\n\telse\n\t\techo '<label for=\"blogname\">' . __('Site Domain:') . '</label>';\n\n\tif ( $errmsg = $errors->get_error_message('blogname') ) { ?>\n\t\t<p class=\"error\"><?php echo $errmsg ?></p>\n\t<?php }\n\n\tif ( !is_subdomain_install() )\n\t\techo '<span class=\"prefix_address\">' . $current_site->domain . $current_site->path . '</span><input name=\"blogname\" type=\"text\" id=\"blogname\" value=\"'. esc_attr($blogname) .'\" maxlength=\"60\" /><br />';\n\telse\n\t\techo '<input name=\"blogname\" type=\"text\" id=\"blogname\" value=\"'.esc_attr($blogname).'\" maxlength=\"60\" /><span class=\"suffix_address\">.' . ( $site_domain = preg_replace( '|^www\\.|', '', $current_site->domain ) ) . '</span><br />';\n\n\tif ( !is_user_logged_in() ) {\n\t\tif ( !is_subdomain_install() )\n\t\t\t$site = $current_site->domain . $current_site->path . __( 'sitename' );\n\t\telse\n\t\t\t$site = __( 'domain' ) . '.' . $site_domain . $current_site->path;\n\t\techo '<p>(<strong>' . sprintf( __('Your address will be %s.'), $site ) . '</strong>) ' . __( 'Must be at least 4 characters, letters and numbers only. It cannot be changed, so choose carefully!' ) . '</p>';\n\t}\n\n\t// Blog Title\n\t?>\n\t<label for=\"blog_title\"><?php _e('Site Title:') ?></label>\n\t<?php if ( $errmsg = $errors->get_error_message('blog_title') ) { ?>\n\t\t<p class=\"error\"><?php echo $errmsg ?></p>\n\t<?php }\n\techo '<input name=\"blog_title\" type=\"text\" id=\"blog_title\" value=\"'.esc_attr($blog_title).'\" />';\n\t?>\n\n\t<div id=\"privacy\">\n        <p class=\"privacy-intro\">\n            <label for=\"blog_public_on\"><?php _e('Privacy:') ?></label>\n            <?php _e( 'Allow search engines to index this site.' ); ?>\n            <br style=\"clear:both\" />\n            <label class=\"checkbox\" for=\"blog_public_on\">\n                <input type=\"radio\" id=\"blog_public_on\" name=\"blog_public\" value=\"1\" <?php if ( !isset( $_POST['blog_public'] ) || $_POST['blog_public'] == '1' ) { ?>checked=\"checked\"<?php } ?> />\n                <strong><?php _e( 'Yes' ); ?></strong>\n            </label>\n            <label class=\"checkbox\" for=\"blog_public_off\">\n                <input type=\"radio\" id=\"blog_public_off\" name=\"blog_public\" value=\"0\" <?php if ( isset( $_POST['blog_public'] ) && $_POST['blog_public'] == '0' ) { ?>checked=\"checked\"<?php } ?> />\n                <strong><?php _e( 'No' ); ?></strong>\n            </label>\n        </p>\n\t</div>\n\n\t<?php\n\tdo_action('signup_blogform', $errors);\n}\n\nfunction validate_blog_form() {\n\t$user = '';\n\tif ( is_user_logged_in() )\n\t\t$user = wp_get_current_user();\n\n\treturn wpmu_validate_blog_signup($_POST['blogname'], $_POST['blog_title'], $user);\n}\n\nfunction show_user_form($user_name = '', $user_email = '', $errors = '') {\n\t// User name\n\techo '<label for=\"user_name\">' . __('Username:') . '</label>';\n\tif ( $errmsg = $errors->get_error_message('user_name') ) {\n\t\techo '<p class=\"error\">'.$errmsg.'</p>';\n\t}\n\techo '<input name=\"user_name\" type=\"text\" id=\"user_name\" value=\"'. esc_attr($user_name) .'\" maxlength=\"60\" /><br />';\n\t_e( '(Must be at least 4 characters, letters and numbers only.)' );\n\t?>\n\n\t<label for=\"user_email\"><?php _e( 'Email&nbsp;Address:' ) ?></label>\n\t<?php if ( $errmsg = $errors->get_error_message('user_email') ) { ?>\n\t\t<p class=\"error\"><?php echo $errmsg ?></p>\n\t<?php } ?>\n\t<input name=\"user_email\" type=\"text\" id=\"user_email\" value=\"<?php  echo esc_attr($user_email) ?>\" maxlength=\"200\" /><br /><?php _e('We send your registration email to this address. (Double-check your email address before continuing.)') ?>\n\t<?php\n\tif ( $errmsg = $errors->get_error_message('generic') ) {\n\t\techo '<p class=\"error\">' . $errmsg . '</p>';\n\t}\n\tdo_action( 'signup_extra_fields', $errors );\n}\n\nfunction validate_user_form() {\n\treturn wpmu_validate_user_signup($_POST['user_name'], $_POST['user_email']);\n}\n\nfunction signup_another_blog($blogname = '', $blog_title = '', $errors = '') {\n\tglobal $current_site;\n\t$current_user = wp_get_current_user();\n\n\tif ( ! is_wp_error($errors) ) {\n\t\t$errors = new WP_Error();\n\t}\n\n\t// allow definition of default variables\n\t$filtered_results = apply_filters('signup_another_blog_init', array('blogname' => $blogname, 'blog_title' => $blog_title, 'errors' => $errors ));\n\t$blogname = $filtered_results['blogname'];\n\t$blog_title = $filtered_results['blog_title'];\n\t$errors = $filtered_results['errors'];\n\n\techo '<h2>' . sprintf( __( 'Get <em>another</em> %s site in seconds' ), $current_site->site_name ) . '</h2>';\n\n\tif ( $errors->get_error_code() ) {\n\t\techo '<p>' . __( 'There was a problem, please correct the form below and try again.' ) . '</p>';\n\t}\n\t?>\n\t<p><?php printf( __( 'Welcome back, %s. By filling out the form below, you can <strong>add another site to your account</strong>. There is no limit to the number of sites you can have, so create to your heart&#8217;s content, but write responsibly!' ), $current_user->display_name ) ?></p>\n\n\t<?php\n\t$blogs = get_blogs_of_user($current_user->ID);\n\tif ( !empty($blogs) ) { ?>\n\n\t\t\t<p><?php _e( 'Sites you are already a member of:' ) ?></p>\n\t\t\t<ul>\n\t\t\t\t<?php foreach ( $blogs as $blog ) {\n\t\t\t\t\t$home_url = get_home_url( $blog->userblog_id );\n\t\t\t\t\techo '<li><a href=\"' . esc_url( $home_url ) . '\">' . $home_url . '</a></li>';\n\t\t\t\t} ?>\n\t\t\t</ul>\n\t<?php } ?>\n\n\t<p><?php _e( 'If you&#8217;re not going to use a great site domain, leave it for a new user. Now have at it!' ) ?></p>\n\t<form id=\"setupform\" method=\"post\" action=\"wp-signup.php\">\n\t\t<input type=\"hidden\" name=\"stage\" value=\"gimmeanotherblog\" />\n\t\t<?php do_action( 'signup_hidden_fields' ); ?>\n\t\t<?php show_blog_form($blogname, $blog_title, $errors); ?>\n\t\t<p class=\"submit\"><input type=\"submit\" name=\"submit\" class=\"submit\" value=\"<?php esc_attr_e( 'Create Site' ) ?>\" /></p>\n\t</form>\n\t<?php\n}\n\nfunction validate_another_blog_signup() {\n\tglobal $wpdb, $blogname, $blog_title, $errors, $domain, $path;\n\t$current_user = wp_get_current_user();\n\tif ( !is_user_logged_in() )\n\t\tdie();\n\n\t$result = validate_blog_form();\n\textract($result);\n\n\tif ( $errors->get_error_code() ) {\n\t\tsignup_another_blog($blogname, $blog_title, $errors);\n\t\treturn false;\n\t}\n\n\t$public = (int) $_POST['blog_public'];\n\t$meta = apply_filters( 'signup_create_blog_meta', array( 'lang_id' => 1, 'public' => $public ) ); // deprecated\n\t$meta = apply_filters( 'add_signup_meta', $meta );\n\n\twpmu_create_blog( $domain, $path, $blog_title, $current_user->ID, $meta, $wpdb->siteid );\n\tconfirm_another_blog_signup($domain, $path, $blog_title, $current_user->user_login, $current_user->user_email, $meta);\n\treturn true;\n}\n\nfunction confirm_another_blog_signup($domain, $path, $blog_title, $user_name, $user_email = '', $meta = '') {\n\t?>\n\t<h2><?php printf( __( 'The site %s is yours.' ), \"<a href='http://{$domain}{$path}'>{$blog_title}</a>\" ) ?></h2>\n\t<p>\n\t\t<?php printf( __( '<a href=\"http://%1$s\">http://%2$s</a> is your new site. <a href=\"%3$s\">Log in</a> as &#8220;%4$s&#8221; using your existing password.' ), $domain.$path, $domain.$path, \"http://\" . $domain.$path . \"wp-login.php\", $user_name ) ?>\n\t</p>\n\t<?php\n\tdo_action( 'signup_finished' );\n}\n\nfunction signup_user($user_name = '', $user_email = '', $errors = '') {\n\tglobal $current_site, $active_signup;\n\n\tif ( !is_wp_error($errors) )\n\t\t$errors = new WP_Error();\n\n\t$signup_for = isset( $_POST[ 'signup_for' ] ) ? esc_html( $_POST[ 'signup_for' ] ) : 'blog';\n\n\t// allow definition of default variables\n\t$filtered_results = apply_filters('signup_user_init', array('user_name' => $user_name, 'user_email' => $user_email, 'errors' => $errors ));\n\t$user_name = $filtered_results['user_name'];\n\t$user_email = $filtered_results['user_email'];\n\t$errors = $filtered_results['errors'];\n\n\t?>\n\n\t<h2><?php printf( __( 'Get your own %s account in seconds' ), $current_site->site_name ) ?></h2>\n\t<form id=\"setupform\" method=\"post\" action=\"wp-signup.php\">\n\t\t<input type=\"hidden\" name=\"stage\" value=\"validate-user-signup\" />\n\t\t<?php do_action( 'signup_hidden_fields' ); ?>\n\t\t<?php show_user_form($user_name, $user_email, $errors); ?>\n\n\t\t<p>\n\t\t<?php if ( $active_signup == 'blog' ) { ?>\n\t\t\t<input id=\"signupblog\" type=\"hidden\" name=\"signup_for\" value=\"blog\" />\n\t\t<?php } elseif ( $active_signup == 'user' ) { ?>\n\t\t\t<input id=\"signupblog\" type=\"hidden\" name=\"signup_for\" value=\"user\" />\n\t\t<?php } else { ?>\n\t\t\t<input id=\"signupblog\" type=\"radio\" name=\"signup_for\" value=\"blog\" <?php checked( $signup_for, 'blog' ); ?> />\n\t\t\t<label class=\"checkbox\" for=\"signupblog\"><?php _e('Gimme a site!') ?></label>\n\t\t\t<br />\n\t\t\t<input id=\"signupuser\" type=\"radio\" name=\"signup_for\" value=\"user\" <?php checked( $signup_for, 'user' ); ?> />\n\t\t\t<label class=\"checkbox\" for=\"signupuser\"><?php _e('Just a username, please.') ?></label>\n\t\t<?php } ?>\n\t\t</p>\n\n\t\t<p class=\"submit\"><input type=\"submit\" name=\"submit\" class=\"submit\" value=\"<?php esc_attr_e('Next') ?>\" /></p>\n\t</form>\n\t<?php\n}\n\nfunction validate_user_signup() {\n\t$result = validate_user_form();\n\textract($result);\n\n\tif ( $errors->get_error_code() ) {\n\t\tsignup_user($user_name, $user_email, $errors);\n\t\treturn false;\n\t}\n\n\tif ( 'blog' == $_POST['signup_for'] ) {\n\t\tsignup_blog($user_name, $user_email);\n\t\treturn false;\n\t}\n\n\twpmu_signup_user($user_name, $user_email, apply_filters( 'add_signup_meta', array() ) );\n\n\tconfirm_user_signup($user_name, $user_email);\n\treturn true;\n}\n\nfunction confirm_user_signup($user_name, $user_email) {\n\t?>\n\t<h2><?php printf( __( '%s is your new username' ), $user_name) ?></h2>\n\t<p><?php _e( 'But, before you can start using your new username, <strong>you must activate it</strong>.' ) ?></p>\n\t<p><?php printf( __( 'Check your inbox at <strong>%s</strong> and click the link given.' ), $user_email ); ?></p>\n\t<p><?php _e( 'If you do not activate your username within two days, you will have to sign up again.' ); ?></p>\n\t<?php\n\tdo_action( 'signup_finished' );\n}\n\nfunction signup_blog($user_name = '', $user_email = '', $blogname = '', $blog_title = '', $errors = '') {\n\tif ( !is_wp_error($errors) )\n\t\t$errors = new WP_Error();\n\n\t// allow definition of default variables\n\t$filtered_results = apply_filters('signup_blog_init', array('user_name' => $user_name, 'user_email' => $user_email, 'blogname' => $blogname, 'blog_title' => $blog_title, 'errors' => $errors ));\n\t$user_name = $filtered_results['user_name'];\n\t$user_email = $filtered_results['user_email'];\n\t$blogname = $filtered_results['blogname'];\n\t$blog_title = $filtered_results['blog_title'];\n\t$errors = $filtered_results['errors'];\n\n\tif ( empty($blogname) )\n\t\t$blogname = $user_name;\n\t?>\n\t<form id=\"setupform\" method=\"post\" action=\"wp-signup.php\">\n\t\t<input type=\"hidden\" name=\"stage\" value=\"validate-blog-signup\" />\n\t\t<input type=\"hidden\" name=\"user_name\" value=\"<?php echo esc_attr($user_name) ?>\" />\n\t\t<input type=\"hidden\" name=\"user_email\" value=\"<?php echo esc_attr($user_email) ?>\" />\n\t\t<?php do_action( 'signup_hidden_fields' ); ?>\n\t\t<?php show_blog_form($blogname, $blog_title, $errors); ?>\n\t\t<p class=\"submit\"><input type=\"submit\" name=\"submit\" class=\"submit\" value=\"<?php esc_attr_e('Signup') ?>\" /></p>\n\t</form>\n\t<?php\n}\n\nfunction validate_blog_signup() {\n\t// Re-validate user info.\n\t$result = wpmu_validate_user_signup($_POST['user_name'], $_POST['user_email']);\n\textract($result);\n\n\tif ( $errors->get_error_code() ) {\n\t\tsignup_user($user_name, $user_email, $errors);\n\t\treturn false;\n\t}\n\n\t$result = wpmu_validate_blog_signup($_POST['blogname'], $_POST['blog_title']);\n\textract($result);\n\n\tif ( $errors->get_error_code() ) {\n\t\tsignup_blog($user_name, $user_email, $blogname, $blog_title, $errors);\n\t\treturn false;\n\t}\n\n\t$public = (int) $_POST['blog_public'];\n\t$meta = array ('lang_id' => 1, 'public' => $public);\n\t$meta = apply_filters( 'add_signup_meta', $meta );\n\n\twpmu_signup_blog($domain, $path, $blog_title, $user_name, $user_email, $meta);\n\tconfirm_blog_signup($domain, $path, $blog_title, $user_name, $user_email, $meta);\n\treturn true;\n}\n\nfunction confirm_blog_signup($domain, $path, $blog_title, $user_name = '', $user_email = '', $meta) {\n\t?>\n\t<h2><?php printf( __( 'Congratulations! Your new site, %s, is almost ready.' ), \"<a href='http://{$domain}{$path}'>{$blog_title}</a>\" ) ?></h2>\n\n\t<p><?php _e( 'But, before you can start using your site, <strong>you must activate it</strong>.' ) ?></p>\n\t<p><?php printf( __( 'Check your inbox at <strong>%s</strong> and click the link given.' ),  $user_email) ?></p>\n\t<p><?php _e( 'If you do not activate your site within two days, you will have to sign up again.' ); ?></p>\n\t<h2><?php _e( 'Still waiting for your email?' ); ?></h2>\n\t<p>\n\t\t<?php _e( 'If you haven&#8217;t received your email yet, there are a number of things you can do:' ) ?>\n\t\t<ul id=\"noemail-tips\">\n\t\t\t<li><p><strong><?php _e( 'Wait a little longer. Sometimes delivery of email can be delayed by processes outside of our control.' ) ?></strong></p></li>\n\t\t\t<li><p><?php _e( 'Check the junk or spam folder of your email client. Sometime emails wind up there by mistake.' ) ?></p></li>\n\t\t\t<li><?php printf( __( 'Have you entered your email correctly?  You have entered %s, if it&#8217;s incorrect, you will not receive your email.' ), $user_email ) ?></li>\n\t\t</ul>\n\t</p>\n\t<?php\n\tdo_action( 'signup_finished' );\n}\n\n// Main\n$active_signup = get_site_option( 'registration' );\nif ( !$active_signup )\n\t$active_signup = 'all';\n\n$active_signup = apply_filters( 'wpmu_active_signup', $active_signup ); // return \"all\", \"none\", \"blog\" or \"user\"\n\n// Make the signup type translatable.\n$i18n_signup['all'] = _x('all', 'Multisite active signup type');\n$i18n_signup['none'] = _x('none', 'Multisite active signup type');\n$i18n_signup['blog'] = _x('blog', 'Multisite active signup type');\n$i18n_signup['user'] = _x('user', 'Multisite active signup type');\n\nif ( is_super_admin() )\n\techo '<div class=\"mu_alert\">' . sprintf( __( 'Greetings Site Administrator! You are currently allowing &#8220;%s&#8221; registrations. To change or disable registration go to your <a href=\"%s\">Options page</a>.' ), $i18n_signup[$active_signup], esc_url( network_admin_url( 'settings.php' ) ) ) . '</div>';\n\n$newblogname = isset($_GET['new']) ? strtolower(preg_replace('/^-|-$|[^-a-zA-Z0-9]/', '', $_GET['new'])) : null;\n\n$current_user = wp_get_current_user();\nif ( $active_signup == 'none' ) {\n\t_e( 'Registration has been disabled.' );\n} elseif ( $active_signup == 'blog' && !is_user_logged_in() ) {\n\t$login_url = site_url( 'wp-login.php?redirect_to=' . urlencode( network_site_url( 'wp-signup.php' ) ) );\n\techo sprintf( __( 'You must first <a href=\"%s\">log in</a>, and then you can create a new site.' ), $login_url );\n} else {\n\t$stage = isset( $_POST['stage'] ) ?  $_POST['stage'] : 'default';\n\tswitch ( $stage ) {\n\t\tcase 'validate-user-signup' :\n\t\t\tif ( $active_signup == 'all' || $_POST[ 'signup_for' ] == 'blog' && $active_signup == 'blog' || $_POST[ 'signup_for' ] == 'user' && $active_signup == 'user' )\n\t\t\t\tvalidate_user_signup();\n\t\t\telse\n\t\t\t\t_e( 'User registration has been disabled.' );\n\t\tbreak;\n\t\tcase 'validate-blog-signup':\n\t\t\tif ( $active_signup == 'all' || $active_signup == 'blog' )\n\t\t\t\tvalidate_blog_signup();\n\t\t\telse\n\t\t\t\t_e( 'Site registration has been disabled.' );\n\t\t\tbreak;\n\t\tcase 'gimmeanotherblog':\n\t\t\tvalidate_another_blog_signup();\n\t\t\tbreak;\n\t\tcase 'default':\n\t\tdefault :\n\t\t\t$user_email = isset( $_POST[ 'user_email' ] ) ? $_POST[ 'user_email' ] : '';\n\t\t\tdo_action( 'preprocess_signup_form' ); // populate the form from invites, elsewhere?\n\t\t\tif ( is_user_logged_in() && ( $active_signup == 'all' || $active_signup == 'blog' ) )\n\t\t\t\tsignup_another_blog($newblogname);\n\t\t\telseif ( is_user_logged_in() == false && ( $active_signup == 'all' || $active_signup == 'user' ) )\n\t\t\t\tsignup_user( $newblogname, $user_email );\n\t\t\telseif ( is_user_logged_in() == false && ( $active_signup == 'blog' ) )\n\t\t\t\t_e( 'Sorry, new registrations are not allowed at this time.' );\n\t\t\telse\n\t\t\t\t_e( 'You are logged in already. No need to register again!' );\n\n\t\t\tif ( $newblogname ) {\n\t\t\t\t$newblog = get_blogaddress_by_name( $newblogname );\n\n\t\t\t\tif ( $active_signup == 'blog' || $active_signup == 'all' )\n\t\t\t\t\tprintf( __( '<p><em>The site you were looking for, <strong>%s</strong> does not exist, but you can create it now!</em></p>' ), $newblog );\n\t\t\t\telse\n\t\t\t\t\tprintf( __( '<p><em>The site you were looking for, <strong>%s</strong>, does not exist.</em></p>' ), $newblog );\n\t\t\t}\n\t\t\tbreak;\n\t}\n}\n?>\n</div>\n</div>\n<?php do_action( 'after_signup_form' ); ?>\n\n<?php get_footer(); ?>\n"]],"start1":0,"start2":0,"length1":0,"length2":18219}]],"length":18219}
